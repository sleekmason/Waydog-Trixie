#!/bin/bash
echo ""
read -p "   [0;33mSnap Installer[0m

   This will install Snapd and the Snap App Store, the app store 
   for Linux.
   
   Please note that the installation can take a while for a slow
   connection as snap searches for resources. About 7 minutes on
   a fairly decent connection here.

   [0;34mhttps://snapcraft.io//[0m
   
   [0;32m-------------------------------------------------------------
   
   Please press enter to install Snap.
   
   -------------------------------------------------------------[0m
   
   
   Or, close this terminal window to quit the install." ;

    echo ""
    sudo apt update
    sudo apt install -y snapd || true

    echo "[0;32mEnabling snapd service...[0m"
    sudo systemctl enable --now snapd.socket
    sudo systemctl enable --now snapd.service

    echo "Waiting for snapd to become ready..."
    for _ in {1..60}; do
        snap version >/dev/null 2>&1 && break
        sleep 2
    done

    if ! snap version >/dev/null 2>&1; then
        echo "[0;31mSnapd failed to start.[0m"
        read -n1 -p " Press any key to quit this dialog ... "
        exit 1
    fi


    echo "[0;32mInstalling the Snap Store ... This can take a while.[0m"
    if ! sudo snap install snap-store; then
        echo "Snap failed â€” applying IPv4 workaround..."

        sudo mkdir -p /etc/systemd/system/snapd.service.d
        sudo tee /etc/systemd/system/snapd.service.d/ipv4.conf >/dev/null <<'EOF'
[Service]
Environment=SNAPD_DISABLE_IPV6=1
EOF

        sudo systemctl daemon-reexec
        sudo systemctl restart snapd

        echo "Retrying Snap Store install..."
        if ! sudo snap install snap-store; then
            echo ""
            echo "[0;31mSnap installation failed even after workaround.[0m"
            echo "[0;31mPlease check network/DNS and try again.[0m"
            read -n1 -p " Press any key to quit this dialog ... "
            exit 1
        fi
    fi

    echo ""
    echo "[0;32m---------------------------------------------------------------"
    echo ""
    echo "All finished! For menus other than Wmenu, logging out and back in"
    echo "will be necessary for the App Center to show in the menu."
    echo "" 
    echo "---------------------------------------------------------------[0m"
    echo ""

read -n1 -p " Press any key to quit this dialog ... "
