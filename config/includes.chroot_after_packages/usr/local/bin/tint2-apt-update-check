#!/bin/bash
# Updater script for waydog.

# Terminal order preference.
TERMINALS=("xfce4-terminal" "foot" "wezterm" "alacritty" "gnome-terminal" "kitty" "x-terminal-emulator")

# Find first available terminal.
TERM_CMD=""
for term in "${TERMINALS[@]}"; do
    if command -v "$term" >/dev/null 2>&1; then
        TERM_CMD="$term"
        break
    fi
done

if [[ -z "$TERM_CMD" ]]; then
    echo "No terminal emulator found." >&2
    exit 1
fi

# Determine whether to use nala or apt.
if command -v nala >/dev/null 2>&1; then
    UPGRADE_CMD="nala"
else
    UPGRADE_CMD="apt"
fi

run_in_terminal() {
    SCRIPT="$1"
    case "$TERM_CMD" in
        xfce4-terminal)
            "$TERM_CMD" --hold --command "bash '$SCRIPT'"
            ;;
        gnome-terminal|x-terminal-emulator)
            "$TERM_CMD" -- bash "$SCRIPT"
            ;;
        kitty)
            "$TERM_CMD" bash "$SCRIPT"
            ;;
        alacritty|wezterm|foot)
            "$TERM_CMD" -e bash "$SCRIPT"
            ;;
        *)
            "$TERM_CMD" -e bash "$SCRIPT"
            ;;
    esac
}

# Count upgrades. (excluding held packages)
num_upgrades=$(( $(apt list --upgradable 2>/dev/null | wc -l) - $(apt-mark showhold | wc -l) - 1 ))

if (( num_upgrades == 0 )); then
    notify-send -i "/usr/share/icons/gnome/48x48/categories/applications-other.png" \
        -t 10000 --urgency low "No upgrades available."
    exit 0
fi

notify-send -i "/usr/share/icons/gnome/48x48/categories/applications-other.png" \
    -t 10000 --urgency low "$num_upgrades Upgrade(s) currently available."

# Temporary script to run in terminal.
TMP_SCRIPT=$(mktemp)

{
    echo 'echo ""'
    echo 'echo "[0;33mAvailable upgrades:[0m"'
    echo 'echo ""'
    if [[ "$UPGRADE_CMD" == "nala" ]]; then
        echo 'nala list --upgradeable'
    else
        echo 'APT_PAGER=cat apt list --upgradable'
    fi
    echo 'echo ""'
    echo 'echo "[0;32m-------------------------------------------------------[0m"'
    echo 'echo ""'
    echo 'held=$(apt-mark showhold)'
    echo 'if [[ -z "$held" ]]; then'
    echo '    echo "[0;34mHeld packages:[0m 0"'
    echo 'else'
    echo '    echo "[0;34mHeld packages:[0m $held"'
    echo 'fi'
    echo 'echo ""'
    echo 'echo "[0;33mPlease enter your password to upgrade, or exit to quit.[0m"'
    echo 'echo ""'

    if [[ "$UPGRADE_CMD" == "nala" ]]; then
        echo 'sudo nala upgrade'
    else
        echo 'sudo apt upgrade'
    fi

    echo 'bash'
} > "$TMP_SCRIPT"

chmod +x "$TMP_SCRIPT"
run_in_terminal "$TMP_SCRIPT"
