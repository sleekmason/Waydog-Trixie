#!/bin/bash

# Simple upgrade notifier for Wayland-only systems
# Sends a notification if no upgrades, or opens a terminal with upgrades listed

# Preferred terminal order
TERMINALS=("xfce4-terminal" "foot" "wezterm" "alacritty" "gnome-terminal" "kitty" "x-terminal-emulator")

# Find first available terminal
TERM_CMD=""
for term in "${TERMINALS[@]}"; do
    if command -v "$term" >/dev/null 2>&1; then
        TERM_CMD="$term"
        break
    fi
done

if [[ -z "$TERM_CMD" ]]; then
    echo "No terminal emulator found. Please install xfce4-terminal, foot, wezterm, alacritty, gnome-terminal, or kitty." >&2
    exit 1
fi

# Check for available upgrades
num_upgrades=$(( $(apt list --upgradable 2>/dev/null | wc -l) - $(apt-mark showhold | wc -l) - 1 ))

# If no upgrades, just notify
if (( num_upgrades == 0 )); then
    notify-send -t 10000 --urgency low "No Upgrades Available"
    exit 0
fi

# If upgrades available, notify
notify-send -t 10000 --urgency low "$num_upgrades Upgrade(s) Currently Available"

# Open terminal to show upgrades and allow user to proceed
if [ -x /usr/bin/nala ]; then
    "$TERM_CMD" -e sh -c 'printf "%s\n" "Available upgrades:"; \
    apt list --upgradeable; printf "\n%s\n" "Held packages:"; \
    apt-mark showhold; echo "... Done"; echo ""; echo \
    "Please enter your password to continue to upgrade your system."; echo \
    "Or close this window to quit now.  <ctrl + c>"; echo ""; \
    sudo nala upgrade; bash;'
else
    "$TERM_CMD" -e sh -c 'printf "%s\n" "Available upgrades:"; \
    apt list --upgradeable; printf "\n%s\n" "Held packages:"; \
    apt-mark showhold; echo "... Done"; echo ""; echo \
    "Please enter your password to continue to upgrade your system."; echo \
    "Or close this window to quit now.  <ctrl + c>"; echo ""; \
    sudo apt upgrade; bash;'
fi
