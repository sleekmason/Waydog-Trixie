#!/bin/bash
read -p "   [0;33mWayfire Compositor Installer[0m

   Wayfire is a 3D Wayland compositor inspired by Compiz and based
   on wlroots. It aims to create a customizable, extendable and
   lightweight environment without sacrificing appearance.
   
   This script will install Wayfire, and wf-shell to provide panel
   support. Custom configurations will be added to ~/.config for
   wayfire and wf-shell customizations.
   
   
   [0;34mhttps://wayfire.org/[0m
   
   
   [0;32m---------------------------------------------------------------

   Please press enter to install the Wayfire Compositor.

   ---------------------------------------------------------------[0m

   Or, close this terminal window to quit the install." ;
## Make sure of internet connection.
#if : >/dev/tcp/8.8.8.8/53; then
if ping -c 1 -W 2 8.8.8.8 &> /dev/null || curl -s --head https://google.com | head -n 1 | grep "HTTP" &> /dev/null; then
echo ""
cd /tmp || exit
rm -f "wayfire.zip"
rm -fr "wayfire"
wget https://raw.githubusercontent.com/sleekmason/packages/master/wayfire.zip --show-progress -q || exit
unzip -q "/tmp/wayfire.zip"

sudo apt update
sudo apt install -y wayfire wf-shell cbatticon upower

# List of items to back up (files or directories)
backup_items=("wayfire.ini" "wf-shell.ini" "wf-shell")

for item in "${backup_items[@]}"; do
    src="$HOME/.config/$item"
    bak="$HOME/.config/$item.bak"

    # Only proceed if the source exists
    if [ -e "$src" ]; then
        # Remove any existing backup
        if [ -e "$bak" ]; then
            if [ -d "$bak" ]; then
                rm -rf "$bak"     # remove directory backup
            else
                rm -f "$bak"      # remove file backup
            fi
        fi

        # Copy source to backup
        cp -r "$src" "$bak"
    fi
done

## Copy files from /tmp.
cp -f "/tmp/wayfire/wf-shell.ini" "$HOME/.config"
cp -f "/tmp/wayfire/wayfire.ini" "$HOME/.config"
cp -fr "/tmp/wayfire/wf-shell" "$HOME/.config"
sudo cp -f "/tmp/wayfire/wfpanel-toggle" "/usr/local/bin"
sudo cp -f "/tmp/wayfire/wayfire-keys.sh" "/usr/local/bin"

## Explain items.
echo "   [0;32m--------------------------------------------------------[0m"
echo ""
echo "   [0;33mAll Finished![0m"
echo ""
echo "   [0;32mYou should find a new login entry for Wayfire.[0m"
echo ""
echo "   [0;32m--------------------------------------------------------[0m"
echo ""
else
echo ""
 echo "   [0;31m-----------------------------------------------------[0m"
 echo ""
 echo "   [0;33mNo Internet connection. Please connect and try again.[0m"
 echo ""
 echo "   [0;31m-----------------------------------------------------[0m"
echo ""
fi
read -n1 -p " Press any key to quit this dialog ... "
