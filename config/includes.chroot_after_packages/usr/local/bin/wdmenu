#!/bin/bash
# wdmenu  Made for waydog by sleekmason 13 Jan 2026
# See config settings in ~/.config/wmenu/config
# Note line 11 for allowed directories

set -euo pipefail

showhelp() {
    echo "wdmenu - Wrapper for wmenu. Shows only those programs with"
    echo "  .desktop files, and any scripts in ~/bin or ~/.local/bin."
    echo ""
    echo "Usage:"
    echo "  wdmenu [options]"
    echo ""
    echo "Options:"
    echo "  --all      Show all programs available on the system."
}
if [ "${1-}" = "--help" ] || [ "${1-}" = "-h" ]; then
    showhelp
    exit 0
fi

CONFIG="$HOME/.config/wmenu/config"
[ -f "$CONFIG" ] && source "$CONFIG"

# If --all, pass everything to wmenu-run
[ "${1-}" = "--all" ] && { shift; exec wmenu-run "${WMENU_OPTS[@]}" "$@"; }

# Allowed directories
ALLOWED_DIRS="/usr/bin /usr/local/bin /usr/sbin $HOME/bin $HOME/.local/bin /usr/libexec /snap/bin"

# Build menu
declare -A MENU_MAP

# Add entries from .desktop files
for f in /usr/share/applications/*.desktop ~/.local/share/applications/*.desktop /var/lib/snapd/desktop/applications/*.desktop; do
    [ -f "$f" ] || continue

    # Get Name and Exec from the .desktop file
    NAME=$(awk -F= '/^Name=/ {print $2; exit}' "$f")
    EXEC=$(awk -F= '/^Exec=/ {print $2; exit}' "$f")

    # Remove common placeholders
    for ph in %U %F %f %i %c %k; do
        EXEC=${EXEC//$ph/}
    done

    # Skip empty Exec
    [ -z "$EXEC" ] && continue

    # Directory check
    EXE_NAME="${EXEC%% *}"
    EXEC_PATH=$(command -v "$EXE_NAME" 2>/dev/null) || continue
    EXE_DIR=$(dirname "$EXEC_PATH")
    [[ " $ALLOWED_DIRS " == *" $EXE_DIR "* ]] || continue

    # Terminal detection .desktop
    TYPE=$(awk -F= '/^Terminal=/ {print $2; exit}' "$f")
    if [[ "$TYPE" == "true" ]]; then
        EXEC="x-terminal-emulator -e $EXEC"
    fi

    MENU_MAP["$NAME"]="$EXEC"
done

# Include all executables in ~/bin and ~/.local/bin
for dir in "$HOME/bin" "$HOME/.local/bin"; do
    [ -d "$dir" ] || continue
    for exe in "$dir"/*; do
        [ -x "$exe" ] || continue
        name=$(basename "$exe")
        [ -n "${MENU_MAP[$name]+x}" ] && continue  # skip if already in menu

        # Terminal detection for ~/bin and ~/.local/bin
        needs_terminal=false
        if grep -qE '(^|[[:space:]])read\b|select\b' "$exe" 2>/dev/null; then
            needs_terminal=true
        fi
        [ "$needs_terminal" = true ] && EXEC="x-terminal-emulator -e $exe" || EXEC="$exe"

        MENU_MAP["$name"]="$EXEC"
    done
done

# Sorted case-insensitive 
selected=$(printf '%s\n' "${!MENU_MAP[@]}" | sort -f | wmenu "${WMENU_OPTS[@]}")

# Launch
if [ -n "$selected" ]; then
    cmd="${MENU_MAP["$selected"]}"
    bash -c "$cmd" &
fi
