#!/bin/bash
# wdmenu  Made for waydog by sleekmason 13 Jan 2026
# See config settings in ~/.config/wmenu/config
# See the whitelist section for problematic programs

set -euo pipefail

showhelp() {
    echo "wdmenu - Wrapper for wmenu. Shows only those programs with"
    echo "  .desktop files, and any scripts in ~/bin or ~/.local/bin."
    echo ""
    echo "Usage:"
    echo "  wdmenu [options]"
    echo ""
    echo "Options:"
    echo "  --all      Show all programs available on the system."
}

if [ "${1-}" = "--help" ] || [ "${1-}" = "-h" ]; then
    showhelp
    exit 0
fi

CONFIG="$HOME/.config/wmenu/config"
[ -f "$CONFIG" ] && source "$CONFIG"

[ "${1-}" = "--all" ] && { shift; exec wmenu-run "${WMENU_OPTS[@]}" "$@"; }

BIN_DIRS="/usr/bin /usr/local/bin /usr/sbin $HOME/bin $HOME/.local/bin /usr/libexec /snap/bin"

declare -A MENU_MAP
declare -A CMD_CACHE

DESKTOP_DIRS=(
    "/usr/share/applications"
    "$HOME/.local/share/applications"
    "/var/lib/snapd/desktop/applications"
)

for d in "${DESKTOP_DIRS[@]}"; do
    [ -d "$d" ] || continue
    for f in "$d"/*.desktop; do
        [ -f "$f" ] || continue
        NAME=""
        EXEC=""
        TYPE=""

        while IFS='=' read -r key value; do
            case $key in
                Name) NAME=$value ;;
                Exec) EXEC=$value ;;
                Terminal) TYPE=$value ;;
            esac
        done < "$f"

        [ -z "$EXEC" ] && continue
        [ -z "$NAME" ] && continue

        for ph in %U %F %f %i %c %k; do
            EXEC=${EXEC//$ph/}
        done

        EXE_NAME="${EXEC%% *}"
        if [[ -z "${CMD_CACHE[$EXE_NAME]+x}" ]]; then
            CMD_CACHE[$EXE_NAME]=$(command -v "$EXE_NAME" 2>/dev/null || echo "")
        fi
        EXEC_PATH=${CMD_CACHE[$EXE_NAME]}
        [ -z "$EXEC_PATH" ] && continue
        EXE_DIR=$(dirname "$EXEC_PATH")
        [[ " $BIN_DIRS " == *" $EXE_DIR "* ]] || continue

        if [[ "$TYPE" == "true" ]]; then
            EXEC="x-terminal-emulator -e \"$EXEC\""
        fi
        MENU_MAP["$NAME"]="$EXEC"
    done
done

# Include ~/bin and ~/.local/bin
for dir in "$HOME/bin" "$HOME/.local/bin"; do
    [ -d "$dir" ] || continue
    for exe in "$dir"/*; do
        [ -x "$exe" ] || continue
        name=$(basename "$exe")
        [ -n "${MENU_MAP[$name]+x}" ] && continue
        needs_terminal=false
        first_line=$(head -n 1 "$exe" 2>/dev/null || echo "")
        if [[ "$first_line" == *read* ]] || [[ "$first_line" == *select* ]]; then
            needs_terminal=true
        fi
        if [ "$needs_terminal" = true ]; then
            EXEC="x-terminal-emulator -e \"$exe\""
        else
            EXEC="$exe"
        fi
        MENU_MAP["$name"]="$EXEC"
    done
done

# Whitelist rograms with problematic placeholders - %U
ADDED_DESKTOPS=(
    "/usr/share/applications/thunderbird.desktop"
)
for f in "${ADDED_DESKTOPS[@]}"; do
    [ -f "$f" ] || continue
    NAME=$(grep -E '^Name=' "$f" | head -n1 | cut -d'=' -f2)
    EXEC=$(grep -E '^Exec=' "$f" | head -n1 | cut -d'=' -f2)
    TYPE=$(grep -E '^Terminal=' "$f" | head -n1 | cut -d'=' -f2 || echo "false")
    EXEC="${EXEC//$'\r'/}"
    EXEC="${EXEC//$'\n'/}"

    if [[ "$TYPE" == "true" ]]; then
        EXEC="x-terminal-emulator -e \"$EXEC\""
    fi
    MENU_MAP["$NAME"]="$EXEC"
done

selected=$(printf '%s\n' "${!MENU_MAP[@]}" | sort -f | wmenu "${WMENU_OPTS[@]}")

if [ -n "$selected" ]; then
    cmd="${MENU_MAP["$selected"]}"
    bash -c "$cmd" &
fi
