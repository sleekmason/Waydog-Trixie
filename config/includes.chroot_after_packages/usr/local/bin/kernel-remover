#!/bin/bash
# Made for Lilidog by sleekmason 31 Oct 2025

#---------------------------------------------------------------------
# Check for root privileges
#---------------------------------------------------------------------
if [ "$(id -u)" -ne 0 ]; then
    printf "ERROR: This script must be run as root.\n" >&2
    exit 1
fi

#---------------------------------------------------------------------
# Variables and defaults
#---------------------------------------------------------------------
TEXTDOMAIN="kernel-remover"
export TEXTDOMAIN
TEXTDOMAINDIR="/usr/share/locale"
export TEXTDOMAINDIR

TITLE="Kernel Remover"
COOLICON="utilities-system-monitor"
CURRENTKERNEL=$(uname -r)
CURRENT=" Cannot remove the active kernel  -  '${CURRENTKERNEL}'"

force=0
frontend="yad"
xtra=0

#---------------------------------------------------------------------
usage() {
    echo "$(basename "$0")"
    echo "     -G parameter    choose frontend (text | yad)"
    echo "     -f              force cleanup without confirmation"
    echo "     -h              show this usage"
    exit 1
}
#---------------------------------------------------------------------

while getopts fhxG: name; do
    case $name in
        f) force=1 ;;
        G) frontend="$OPTARG" ;;
        h) usage ;;
        x) xtra=1 ;;
        *) usage ;;
    esac
done
shift $((OPTIND - 1))

#---------------------------------------------------------------------
# Determine frontend (text or yad)
#---------------------------------------------------------------------
if [ -z "$frontend" ]; then
    if [ -n "$DISPLAY" ] && command -v yad >/dev/null 2>&1; then
        frontend="yad"
    else
        frontend="text"
    fi
fi

#---------------------------------------------------------------------
# Wayland / sudo handling — force text mode if YAD cannot run properly
#---------------------------------------------------------------------
if [ "$frontend" = "yad" ] && [ -n "$WAYLAND_DISPLAY" ] && [ -z "$DISPLAY" ]; then
    frontend="text"
fi

if [ "$frontend" = "yad" ] && [ -z "$DISPLAY" ]; then
    frontend="text"
fi
#---------------------------------------------------------------------

get_KernelList() {
    KernelList=""
    for v in /boot/vmlinuz-*; do
        Kernel=$(basename "$v" | sed 's/vmlinuz-//')
        if [ "$Kernel" != "$CURRENTKERNEL" ]; then
            KernelList="${KernelList} ${Kernel}"
        fi
    done
}
#---------------------------------------------------------------------
remove_one_kernel() {
    Kernel=$1
    if [ "$Kernel" != "$CURRENTKERNEL" ]; then
        echo "Removing kernel: $Kernel"
        apt-get remove --purge --yes $(dpkg -l | grep "$Kernel" | awk '{print $2}') 2>/dev/null
        dpkg -l "linux-headers-${Kernel}-common" >/dev/null 2>&1 && \
            apt-get remove --purge --yes "linux-headers-${Kernel}-common"
        dpkg -l "linux-support-${Kernel}" >/dev/null 2>&1 && \
            apt-get remove --purge --yes "linux-support-${Kernel}"
        [ ! -e "/boot/vmlinuz-${Kernel}" ] && rm -rf /lib/modules/"${Kernel}"
    fi
}

#---------------------------------------------------------------------
# Main
#---------------------------------------------------------------------
if [ "$xtra" -eq 1 ]; then
    KernelList="$@"
    for i in ${KernelList}; do
        echo "Removing kernel $i"
        remove_one_kernel "$i"
    done
    echo "Removed: ${KernelList}"
    exit 0
fi

get_KernelList

if [ -z "$KernelList" ]; then
    MSG="There is only one kernel installed on this system. Nothing to be done!"
    if [ "$frontend" = "text" ]; then
        echo "$MSG"
    else
        yad --center --borders=10 --width=400 --title="$TITLE" \
            --window-icon="$COOLICON" \
            --text="<span foreground='white'>${MSG}</span>" \
            --button=gtk-ok:0 --gtk-theme="Adwaita:light"
    fi
    exit 0
fi

if [ "$force" -eq 1 ]; then
    echo "$CURRENT"
    for i in ${KernelList}; do
        echo "Removing kernel $i"
        remove_one_kernel "$i"
    done
    echo "Removed: ${KernelList}"
    exit 0
fi

#---------------------------------------------------------------------
# User selection (YAD or TEXT)
#---------------------------------------------------------------------
if [ "$frontend" = "text" ]; then
    echo "$CURRENT"
    echo
    echo "Available kernels to remove:"
    echo

    # Trim whitespace and convert to array
    KernelList_trimmed=$(echo "$KernelList" | xargs)
    read -r -a KARRAY <<< "$KernelList_trimmed"

    # Display numbered list with colored numbers and kernel names
    index=1
    for k in "${KARRAY[@]}"; do
        echo -e "  \033[0;33m$index)\033[0m \033[0;32m$k\033[0m"
        index=$((index+1))
    done
    echo

    echo -ne "Enter the \033[0;33mnumber\033[0m of the \033[0;32mkernel(s)\033[0m to remove (space-separated): "
    read NUMS

    # Convert numbers to kernel names
    CHOICE=""
    for n in $NUMS; do
        if [[ "$n" =~ ^[0-9]+$ ]] && [ "$n" -ge 1 ] && [ "$n" -le "${#KARRAY[@]}" ]; then
            CHOICE="$CHOICE ${KARRAY[$((n-1))]}"
        else
            echo "Invalid selection: $n"
        fi
    done

    CHOICE=$(echo "$CHOICE" | xargs)  # Trim spaces
else
    # Prepare list for yad
    yad_list=()
    for k in ${KernelList}; do
        yad_list+=(FALSE "$k")
    done

    CHOICE=$(yad --list --checklist \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --width=460 --height=222 \
        --center --borders=10 \
        --column="Select" --column="Kernel(s)" \
        --text="<span foreground='white'>${CURRENT}</span>" \
        --separator=" " \
        "${yad_list[@]}" \
        2>/dev/null)

    CHOICE=$(echo "$CHOICE" | sed 's/\bTRUE\b//g')
fi

[ -z "$CHOICE" ] && exit 0

#---------------------------------------------------------------------
# Confirmation dialog before removal
#---------------------------------------------------------------------
if [ "$frontend" = "text" ]; then
    echo
    echo "The following kernel(s) have been selected for removal: ${CHOICE}"
    echo
    echo -ne "\033[0;33m  Would you like to continue? [y/N]: \033[0m"
    read CONFIRM
    case "$CONFIRM" in
        [yY][eE][sS]|[yY]) ;;
        *) echo "Operation canceled."; exit 0 ;;
    esac
else
    BULLETS=""
    for k in ${CHOICE}; do
        BULLETS="${BULLETS}• ${k}\n"
    done

    yad --question \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --width=460 --center --borders=10 \
        --text="<span foreground='white'>The following kernel(s) have been selected for removal:\n<b>${BULLETS}</b>\n\nWould you like to continue?</span>" \
        --button=gtk-yes:0 --button=gtk-no:1
    [ $? -ne 0 ] && exit 0
fi

#---------------------------------------------------------------------
# Proceed with confirmed removal
#---------------------------------------------------------------------
for i in ${CHOICE}; do
    echo
    echo "Confirmed removal for $i"
    remove_one_kernel "$i"
done

if [ "$frontend" = "yad" ]; then
    yad --info \
        --title="$TITLE" \
        --window-icon="$COOLICON" \
        --width=460 --center --borders=10 \
        --text="<span foreground='white'>Removed kernel(s):<b> ${CHOICE}</b></span>" \
else
    echo "Removed kernel(s): ${CHOICE}"
fi
echo
echo -e "\033[0;33m  Kernel removal completed...\033[0m"
echo
echo -e "\033[0;32m  Press any key to quit...\033[0m"
echo
read -srn1

exit 0
