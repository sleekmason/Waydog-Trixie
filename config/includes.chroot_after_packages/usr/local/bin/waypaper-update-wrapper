#!/bin/bash
# Launch Waypaper, wait for exit, then update config.ini
# Made by sleekmason 30 nov 2025

STATE_FILE="$HOME/.config/waypaper/config.ini"
CONFIG_FILE="$HOME/.config/waypaper/config.ini"

# Start waypaper
waypaper --state-file "$STATE_FILE" "$@"

# 3. Read folder and wallpaper from state file
folder=$(grep -E '^folder *= *' "$STATE_FILE" | cut -d= -f2- | xargs)
wallpaper=$(grep -E '^wallpaper *= *' "$STATE_FILE" | cut -d= -f2- | xargs)

# Expand ~
folder="${folder/#\~/$HOME}"
wallpaper="${wallpaper/#\~/$HOME}"

# 5. Update folder and wallpaper in config.ini
for key in folder wallpaper; do
    value="${!key}"
    if grep -q "^$key *= *" "$CONFIG_FILE"; then
        sed -i "s|^$key *=.*|$key = $value|" "$CONFIG_FILE"
    else
        echo "$key = $value" >> "$CONFIG_FILE"
    fi
done

echo "Waypaper config updated:"
echo "  folder = $folder"
echo "  wallpaper = $wallpaper"

exit 0
