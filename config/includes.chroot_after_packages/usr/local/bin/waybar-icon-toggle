#!/bin/bash
# Waybar options
# Made by sleekmason for Waydog 27 Feb 2026

CONFIG=(
    "$HOME/.config/waybar/config.jsonc"
    "$HOME/.config/waybar/sway/config.jsonc"
    "$HOME/.config/waybar/niri/config.jsonc"
)

SIZES_INI="$HOME/.config/waybar/module_defaults.ini"
STATE_FILE="$HOME/.config/waybar/first_run"
STYLE="$HOME/.config/waybar/style.css"
SELF="$(realpath "$BASH_SOURCE")"
MODULES="waybar-modules-toggle"

LONG=22
SHORT=11

restart_waybar() {
    pkill -x waybar
    if pgrep -x sway >/dev/null; then
        waybar -c "$HOME/.config/waybar/sway/config.jsonc" &
    elif pgrep -x niri >/dev/null; then
        waybar -c "$HOME/.config/waybar/niri/config.jsonc" &
    else
        waybar &
    fi
}

get_current_format() {
    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        awk '/"wlr\/taskbar": {/,/}/ { if($0 ~ /"format":/) print }' "$cfg" \
            | grep -Po '"format":\s*"\K[^"]+'
        return
    done
}

apply_format() {
    local fmt="$1"
    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        sed -i '/"wlr\/taskbar": {/,/}/ s/^\(\s*"format":\s*\)".*"/\1"'"$fmt"'"/' "$cfg"
    done

    case "$fmt" in
        "{title:.$LONG}")         notify-send -i preferences-desktop-personal "Text only - Long" ;;
        "{title:.$SHORT}")        notify-send -i preferences-desktop-personal "Text only - Compact" ;;
        "{icon}")                 notify-send -i preferences-desktop-personal "Icons only" ;;
        "{icon} {title:.$LONG}")  notify-send -i preferences-desktop-personal "Text + icons - Long (Default)" ;;
        "{icon} {title:.$SHORT}") notify-send -i preferences-desktop-personal "Text + icons - Compact" ;;
    esac

    restart_waybar
}

toggle_mode() {
    current=$(get_current_format)
    case "$current" in
        "{title:.$LONG}")         new="{title:.$SHORT}" ;;
        "{title:.$SHORT}")        new="{icon}" ;;
        "{icon}")                 new="{icon} {title:.$LONG}" ;;
        "{icon} {title:.$LONG}")  new="{icon} {title:.$SHORT}" ;;
        "{icon} {title:.$SHORT}") new="{title:.$LONG}" ;;
        *)                        new="{icon} {title:.$LONG}" ;;
    esac
    apply_format "$new"
}

toggle_separator() {
    if grep -q 'margin-left: 8px;' "$STYLE"; then
        sed -i '/#custom-separator1 {/,/}/c\
#custom-separator1 {\
    font-size: 0px;\
    margin: 0;\
    padding: 0;\
}' "$STYLE"
        notify_label="OFF"
    else
        sed -i '/#custom-separator1 {/,/}/c\
#custom-separator1 {\
    color: @text-dim;\
    margin-left: 8px;\
    margin-right: 5px;\
}' "$STYLE"
        notify_label="ON"
    fi
    notify-send -i preferences-desktop "Separator  ▸  $notify_label"
    restart_waybar
}

declare -A DEFAULT_SIZES=(
    ["#workspaces button"]=11
    ["#waybar"]=13
    ["#clock"]=13
    ["#cpu"]=13
    ["#memory"]=13
    ["#temperature"]=13
    ["#pulseaudio"]=13
    ["#backlight"]=13
    ["#network"]=13
    ["#battery"]=13
    ["#language"]=13
    ["#idle_inhibitor"]=14
    ["#custom-launcher1"]=14
    ["#custom-launcher2"]=11
    ["#custom-launcher3"]=12
    ["#custom-launcher4"]=9.5
    ["#scratchpad"]=11
    ["#mpd"]=12
    ["#custom-power"]=12
)

INI_ENTRIES=(
    "waybar|#waybar|Main bar fontsize"
    "workspaces button|#workspaces button|Workspaces"
    "clock|#clock|Clock"
    "cpu|#cpu|CPU"
    "memory|#memory|Memory"
    "temperature|#temperature|Temperature"
    "pulseaudio|#pulseaudio|Audio"
    "backlight|#backlight|Backlight"
    "network|#network|Network"
    "battery|#battery|Battery"
    "scratchpad|#scratchpad|Scratchpad"
    "idle_inhibitor|#idle_inhibitor|Idle Inhibitor"
    "mpd|#mpd|Music Player"
    "language|#language|Language"
    "custom-power|#custom-power|Power Button"
    "custom-launcher1|#custom-launcher1|Menu Icon"
    "custom-launcher2|#custom-launcher2|Files Icon"
    "custom-launcher3|#custom-launcher3|Terminal Icon"
    "custom-launcher4|#custom-launcher4|Showdesktop Icon"
)

read_size_from_css() {
    local selector="$1"
    local escaped
    escaped=$(echo "$selector" | sed 's/ /\\ /g')
    sed -n "/$escaped {/,/}/ {/font-size:/ {s/.*font-size: \([0-9.]\+\)px;.*/\1/p}}" "$STYLE"
}

write_ini_file() {
    if [[ ! -f "$STATE_FILE" ]]; then
        mkdir -p "$(dirname "$STATE_FILE")"
        touch "$STATE_FILE"
        use_css=true
    else
        use_css=false
    fi

    mkdir -p "$(dirname "$SIZES_INI")"
    {
        echo "# These are your reset values used by the Reset All button. Edit these"
        echo "# values to define your own baseline, or delete this file and press"
        echo "# 'Waybar Main Size' to regenerate it with the distro defaults."
        echo ""
        echo "# To generate it from the current style.css file instead, remove the"
        echo "# 'first_run' file before pressing 'Waybar Main Size'."
        for entry in "${INI_ENTRIES[@]}"; do
            IFS='|' read -r ini_key css_selector label <<< "$entry"
            if [[ "$use_css" == true && -f "$STYLE" ]]; then
                val=$(read_size_from_css "$css_selector")
                val="${val:-${DEFAULT_SIZES[$css_selector]}}"
            else
                val="${DEFAULT_SIZES[$css_selector]}"
            fi
            echo ""
            echo "# ${label}"
            echo "${ini_key}=${val}"
        done
    } > "$SIZES_INI"
}

read_ini_file() {
    local -n _target=$1
    while IFS='=' read -r key val; do
        [[ -z "$key" || "$key" == "# "* ]] && continue
        # Strip carriage returns
        key="${key%$'\r'}"
        val="${val%$'\r'}"
        # Strip leading/trailing whitespace only
        key="${key#"${key%%[![:space:]]*}"}"
        key="${key%"${key##*[![:space:]]}"}"
        val="${val#"${val%%[![:space:]]*}"}"
        val="${val%"${val##*[![:space:]]}"}"
        [[ -n "$key" && -n "$val" ]] && _target[$key]="$val"
    done < "$SIZES_INI"
}

ini_key_to_selector() {
    local ini_key="$1"
    for entry in "${INI_ENTRIES[@]}"; do
        IFS='|' read -r ik css label <<< "$entry"
        if [[ "$ik" == "$ini_key" ]]; then
            echo "$css"
            return
        fi
    done
}

toggle_barcolor() {
    declare -A COLORS=(
        ["24,37,43"]="Blue"
        ["0,0,0"]="Black"
        ["26,26,26"]="Brown"
        ["25,31,41"]="Purple"
        ["54,59,61"]="Gray"
        ["16,36,26"]="Green"
    )
    COLOR_CYCLE=(
        "24,37,43"
        "0,0,0"
        "26,26,26"
        "25,31,41"
        "54,59,61"
        "16,36,26"
    )

    current=$(sed -n 's/@define-color base *rgba(\([0-9]\+, *[0-9]\+, *[0-9]\+\),.*/\1/p' "$STYLE" | tr -d ' ')

    idx=0
    for i in "${!COLOR_CYCLE[@]}"; do
        [[ "${COLOR_CYCLE[$i]}" == "$current" ]] && idx=$i
    done

    next_idx=$(( (idx + 1) % ${#COLOR_CYCLE[@]} ))
    new="${COLOR_CYCLE[$next_idx]}"
    label="${COLORS[$new]}"

    sed -i "s/@define-color base *rgba([0-9]\+, *[0-9]\+, *[0-9]\+,/@define-color base        rgba(${new},/" "$STYLE"

    notify-send -i preferences-desktop "Waybar Bar Color  ▸  $label"
    restart_waybar
}

toggle_iconscale() {
    if ! command -v bc >/dev/null 2>&1; then
        notify-send -i preferences-desktop-font \
            "'bc' must be installed for this to work"
        return
    fi

    if [[ ! -f "$SIZES_INI" ]]; then
        write_ini_file
        notify-send -i preferences-desktop-font \
            "Created module_defaults.ini — edit to customise your reset baseline"
    fi

    scale=$(grep -oP '/\*\s*ICON_SCALE:\K-?[0-9]+' "$STYLE" | head -n1)
    [[ -z "$scale" ]] && scale=0

    new=$((scale + 1))
    [[ $new -gt 2 ]] && new=-3

    delta=$((new - scale))

    for entry in "${INI_ENTRIES[@]}"; do
        IFS='|' read -r ini_key css_selector label <<< "$entry"
        escaped=$(echo "$css_selector" | sed 's/ /\\ /g')
        base=$(read_size_from_css "$css_selector")
        base="${base:-${DEFAULT_SIZES[$css_selector]}}"
        newsize=$(bc <<< "scale=1; $base + $delta")
        if grep -q "font-size:" < <(sed -n "/$escaped {/,/}/p" "$STYLE"); then
            sed -i "/$escaped {/,/}/ s/font-size: [0-9.]\+px;/font-size: ${newsize}px;/" "$STYLE"
        else
            sed -i "/$escaped {/ a\\  font-size: ${newsize}px;" "$STYLE"
        fi
    done

    if grep -q "ICON_SCALE" "$STYLE"; then
        sed -i "s/\/\* ICON_SCALE:.*\*\//\/\* ICON_SCALE:$new \*\//" "$STYLE"
    else
        echo "/* ICON_SCALE:$new */" >> "$STYLE"
    fi

    tray_size=$(bc <<< "14 + $new")
    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        sed -i '/"tray": {/{:a; n; /"icon-size":/ { s/\("icon-size": \)[0-9]\+/\1'"$tray_size"'/; b }; ba }' "$cfg"
    done

    SCALE_OPTIONS=(-3 -2 -1 0 1 2)
    SCALE_LABELS=("Smallest" "Small" "Medium" "Default" "Large" "Largest")
    idx=0
    for i in "${!SCALE_OPTIONS[@]}"; do
        [[ "${SCALE_OPTIONS[$i]}" == "$new" ]] && idx=$i
    done
    label="${SCALE_LABELS[$idx]}"

    notify-send -i preferences-desktop-font "Waybar Main  ▸  $label"
    restart_waybar
}

toggle_taskbar_iconsize() {
    DEFAULT_ICON=14
    OPTIONS=(10 12 14 16 18 20)
    LABELS=("Smallest" "Small" "Default" "Large" "Extra Large" "Largest")

    idx=0

    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        current=$(sed -n '/"wlr\/taskbar": {/{:a; n; /"icon-size":/ { s/[^0-9]*\([0-9]\+\).*/\1/; p; q }; ba }' "$cfg")
        break
    done

    [[ " ${OPTIONS[*]} " =~ " $current " ]] || current=$DEFAULT_ICON

    for i in "${!OPTIONS[@]}"; do
        [[ "${OPTIONS[$i]}" == "$current" ]] && idx=$i
    done

    next_idx=$(( (idx + 1) % ${#OPTIONS[@]} ))
    new=${OPTIONS[$next_idx]}

    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        sed -i '/"wlr\/taskbar": {/{:a; n; /"icon-size":/ { s/\("icon-size": \)[0-9]\+/\1'"$new"'/; b }; ba }' "$cfg"
    done

    notify_label="${LABELS[$next_idx]}"
    notify-send -i preferences-desktop-font "Taskbar Icon Size  ▸  $notify_label"
    restart_waybar
}

toggle_fontsize() {
    current=$(sed -n '/#taskbar button {/,/}/ {/font-size:/ {s/[^0-9]*\([0-9]\+\)px;/\1/p}}' "$STYLE")
    case "$current" in
        10) new=11 ;;
        11) new=12 ;;
        12) new=13 ;;
        13) new=14 ;;
        14) new=15 ;;
        15) new=16 ;;
        16) new=10 ;;
        *)  new=12 ;;
    esac
    sed -i '/#taskbar button {/,/}/ s/\(font-size:\s*\)[0-9]\+px;/\1'"$new"'px;/' "$STYLE"
    if [[ "$new" -eq 12 ]]; then notify_label="$new px (Default)"; else notify_label="$new px"; fi
    notify-send -i preferences-desktop "Taskbar Font Size  ▸  $notify_label"
    restart_waybar
}

toggle_textcolor() {
    current=$(sed -n '/#taskbar button {/,/}/ {/color:/ {s/.*color:\s*\([^;]*\);.*/\1/p}}' "$STYLE")
    case "$current" in
        "#000000") new="#1A1A1A"; notify_label="Darkest" ;;
        "#1A1A1A") new="#A3A3A3"; notify_label="Darker" ;;
        "#A3A3A3") new="#C4C4C4"; notify_label="Dark" ;;
        "#C4C4C4") new="#E0E0E0"; notify_label="Default" ;;
        "#E0E0E0") new="#FFFFFF"; notify_label="Brightest" ;;
        "#FFFFFF") new="#000000"; notify_label="Black" ;;
        *)         new="#E0E0E0"; notify_label="Default" ;;
    esac
    sed -i '/#taskbar button {/,/}/ s/\(color:\s*\)[^;]\+;/\1'"$new"';/' "$STYLE"
    notify-send -i preferences-desktop "Taskbar Text Color  ▸  $notify_label"
    restart_waybar
}

toggle_transparency() {
    current=$(sed -n 's/@define-color base *rgba([^,]*,[^,]*,[^,]*, *\([0-9.]\+\)).*/\1/p' "$STYLE")
    case "$current" in
        0.9) new=0.8 ;;
        0.8) new=0.7 ;;
        0.7) new=0.6 ;;
        0.6) new=0.5 ;;
        0.5) new=0.4 ;;
        0.4) new=0.3 ;;
        0.3) new=0.2 ;;
        0.2) new=0.1 ;;
        0.1) new=0.0 ;;
        0.0) new=1.0 ;;
        1.0) new=0.9 ;;
        *)   new=0.9 ;;
    esac
    sed -i "s/\(@define-color base *rgba([^,]*,[^,]*,[^,]*, *\)[0-9.]\+/\1${new}/" "$STYLE"
    case "$new" in
        1.0) display="Solid" ;;
        0.9) display="10% (Default)" ;;
        0.8) display="20%" ;;
        0.7) display="30%" ;;
        0.6) display="40%" ;;
        0.5) display="50%" ;;
        0.4) display="60%" ;;
        0.3) display="70%" ;;
        0.2) display="80%" ;;
        0.1) display="90%" ;;
        0.0) display="100%" ;;
    esac
    notify-send -i preferences-desktop "Waybar Transparency  ▸  $display"
    restart_waybar
}

reset_defaults() {
    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        sed -i '/"wlr\/taskbar": {/,/}/ s/^\(\s*"format":\s*\)".*"/\1"{icon} {title:.'"$LONG"'}"/' "$cfg"
        sed -i '/"wlr\/taskbar": {/{:a; n; /"icon-size":/ { s/\("icon-size": \)[0-9]\+/\114/; b }; ba }' "$cfg"
        sed -i '/"tray": {/{:a; n; /"icon-size":/ { s/\("icon-size": \)[0-9]\+/\114/; b }; ba }' "$cfg"
    done

    declare -A RESET_SIZES
    if [[ -f "$SIZES_INI" ]]; then
        read_ini_file RESET_SIZES
    else
        for entry in "${INI_ENTRIES[@]}"; do
            IFS='|' read -r ini_key css_selector label <<< "$entry"
            RESET_SIZES[$ini_key]="${DEFAULT_SIZES[$css_selector]}"
        done
    fi

    for ini_key in "${!RESET_SIZES[@]}"; do
        selector=$(ini_key_to_selector "$ini_key")
        [[ -z "$selector" ]] && continue
        escaped=$(echo "$selector" | sed 's/ /\\ /g')
        if grep -q "font-size:" < <(sed -n "/$escaped {/,/}/p" "$STYLE"); then
            sed -i "/$escaped {/,/}/ s/font-size: [0-9.]\+px;/font-size: ${RESET_SIZES[$ini_key]}px;/" "$STYLE"
        else
            sed -i "/$escaped {/ a\\  font-size: ${RESET_SIZES[$ini_key]}px;" "$STYLE"
        fi
    done

    sed -i "s/\/\* ICON_SCALE:.*\*\//\/\* ICON_SCALE:0 \*\//" "$STYLE"
    sed -i "s/@define-color base *rgba([0-9]\+, *[0-9]\+, *[0-9]\+,/@define-color base        rgba(24,37,43,/" "$STYLE"
    sed -i '/#taskbar button {/,/}/ s/\(font-size:\s*\)[0-9]\+px;/\112px;/' "$STYLE"
    sed -i '/#taskbar button {/,/}/ s/\(color:\s*\)[^;]\+;/\1#E0E0E0;/' "$STYLE"
    sed -i "s/\(@define-color base *rgba([^,]*,[^,]*,[^,]*, *\)[0-9.]\+/\10.9/" "$STYLE"
    sed -i '/#custom-separator1 {/,/}/c\
#custom-separator1 {\
    font-size: 0px;\
    margin: 0;\
    padding: 0;\
}' "$STYLE"
    sed -i '/^#[a-zA-Z_-]\+.*min-width: 0.*$/d' "$STYLE"

    notify-send -i preferences-desktop "Settings restored to default"
    restart_waybar
}

sway_reset_defaults() {
    for cfg in "${CONFIG[@]}"; do
        [[ -f "$cfg" ]] || continue
        sed -i '/"tray": {/{:a; n; /"icon-size":/ { s/\("icon-size": \)[0-9]\+/\114/; b }; ba }' "$cfg"
    done

    declare -A RESET_SIZES
    if [[ -f "$SIZES_INI" ]]; then
        read_ini_file RESET_SIZES
    else
        for entry in "${INI_ENTRIES[@]}"; do
            IFS='|' read -r ini_key css_selector label <<< "$entry"
            RESET_SIZES[$ini_key]="${DEFAULT_SIZES[$css_selector]}"
        done
    fi

    for ini_key in "${!RESET_SIZES[@]}"; do
        selector=$(ini_key_to_selector "$ini_key")
        [[ -z "$selector" ]] && continue
        escaped=$(echo "$selector" | sed 's/ /\\ /g')
        if grep -q "font-size:" < <(sed -n "/$escaped {/,/}/p" "$STYLE"); then
            sed -i "/$escaped {/,/}/ s/font-size: [0-9.]\+px;/font-size: ${RESET_SIZES[$ini_key]}px;/" "$STYLE"
        else
            sed -i "/$escaped {/ a\\  font-size: ${RESET_SIZES[$ini_key]}px;" "$STYLE"
        fi
    done

    sed -i "s/\/\* ICON_SCALE:.*\*\//\/\* ICON_SCALE:0 \*\//" "$STYLE"
    sed -i "s/@define-color base *rgba([0-9]\+, *[0-9]\+, *[0-9]\+,/@define-color base        rgba(24,37,43,/" "$STYLE"
    sed -i "s/\(@define-color base *rgba([^,]*,[^,]*,[^,]*, *\)[0-9.]\+/\10.9/" "$STYLE"
    sed -i '/#custom-separator1 {/,/}/c\
#custom-separator1 {\
    font-size: 0px;\
    margin: 0;\
    padding: 0;\
}' "$STYLE"
    sed -i '/^#[a-zA-Z_-]\+.*min-width: 0.*$/d' "$STYLE"

    notify-send -i preferences-desktop "Settings restored to default"
    restart_waybar
}

sway_dialog_mode() {
    if ! pgrep -x sway >/dev/null; then
        notify-send -i applications-engineering "Waybar Options" \
            "This dialog for Sway sessions only"
        exit 0
    fi
    yad --title "Waybar Options" --escape-ok \
        --button=" Reset All!edit-clear":"bash '$SELF' sway_reset" \
        --button=" Close!gtk-ok:0" \
        --form --center --width=260 --height=280 --borders=10 \
        --field="":LBL "" \
        --field="       Waybar Main Color!input-dialpad":FBTN              "bash '$SELF' barcolor" \
        --field="         Waybar Icon Size!view-fullscreen":FBTN           "bash '$SELF' iconscale" \
        --field="               Transparency!weather-clear":FBTN           "bash '$SELF' transparency" \
        --field="                   Separators!view-sort-descending":FBTN  "bash '$SELF' separator" \
        --field="                       Modules!system-run":FBTN           "bash '$MODULES' &"
}

dialog_mode() {
    if pgrep -x sway >/dev/null; then
        notify-send -i applications-engineering "Waybar Options" \
            "Try 'Super + Shift + W' for a dialog"
        exit 0
    fi
    yad --title "Waybar Options" \
        --button=" Reset All!edit-clear":"bash '$SELF' reset" \
        --button=" Close!gtk-ok:0" \
        --form --center --width=266 --height=436 --borders=10 \
        --field="":LBL "" \
        --field="      Cycle Taskbar Mode!view-refresh":FBTN                "bash '$SELF'" \
        --field="       Waybar Main Color!input-dialpad":FBTN              "bash '$SELF' barcolor" \
        --field="         Waybar Main Size!view-fullscreen":FBTN           "bash '$SELF' iconscale" \
        --field="         Taskbar Icon Size!view-fullscreen":FBTN          "bash '$SELF' taskbar_iconsize" \
        --field="         Taskbar Font Size!format-justify-center":FBTN    "bash '$SELF' fontsize" \
        --field="            Text Brightness!semi-starred":FBTN            "bash '$SELF' textcolor" \
        --field="               Transparency!weather-clear":FBTN           "bash '$SELF' transparency" \
        --field="                  Separators!view-sort-descending":FBTN   "bash '$SELF' separator" \
        --field="                      Modules!system-run":FBTN            "bash '$MODULES' &"
}

case "$1" in
    dialog)           dialog_mode ;;
    sway_dialog)      sway_dialog_mode ;;
    separator)        toggle_separator ;;
    fontsize)         toggle_fontsize ;;
    barcolor)         toggle_barcolor ;;
    transparency)     toggle_transparency ;;
    textcolor)        toggle_textcolor ;;
    iconscale)        toggle_iconscale ;;
    taskbar_iconsize) toggle_taskbar_iconsize ;;
    sway_reset)       sway_reset_defaults ;;
    reset)            reset_defaults ;;
    *)                toggle_mode ;;
esac
